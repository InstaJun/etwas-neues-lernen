## 51 与STM32区别

### 51 系统结构

![image-20200329210000722](D:\00_LUH\ET-INF\was_neues_lernen_Zusammenfassung\STM32\image-20200329210000722.png)

<center>图1 51系统结构框图

**内核**

- IP核：
	- CPU
- 片上外设
	- 时钟电路、
	- SFR 和
	- RAM、
	- ROM、
	- 定时/计数器、
	- 并行I/O 口、
	- 串行I/O 口、
	- 中断系统

CPU 跟片上外设之间由系统总线连接，且是**8bit**，速度有限

编程的时候操作的寄存器位于SFR 和RAM 这个部分，其中SFR[^1]（特殊功能寄存器）
占有128 字节（实际上只用了26 个字节，只有26 个寄存器，其他都属于保留区），RAM[^2]
占有128 字节，我们在程序中定义的变量就是放在RAM 中。其中SFR 和RAM 在地址上
是重合的，都是在80~FF 这个地址区间，但在物理区间上是分开的，所以51 的RAM 是有
256 个字节。
[^1]: Special Function Register
[^2]: Random Access Memory

<u>编写好的程序是烧写到ROM[^3] 区。剩下的外设都是我们非常熟悉的IO 口，串口、定时器、中断这几个外设。</u>
[^3]:read only memory


### STM 32 系统结构

![image-20200329211325230](D:\00_LUH\ET-INF\was_neues_lernen_Zusammenfassung\STM32\image-20200329211325230.png)

<center> 图2 STM32 系统和结构框图</center>

<img src="https://i.stack.imgur.com/8OKxY.png" alt="enter image description here" style="zoom:200%;" />

**内核**

51和STM 32本质上都是属于单片机,都是由内核和片上外设组成。只是STM32 使用的是Cortex-M3内核比51 复杂，优秀，支持的外设比51多，同时，Bus宽度由51的8路升级到32bit。
从结构框图上看，对比 51 内核只有一种总线，取地址和取数据共用。Cortex-M3 内部有若干个总线接口，以使 CM3 能同时取址和访内（访问内存），它们是：

- 指令存储区总线（两条）、
- 系统总线、
- 私有外设总线。

有两条代码存储区总线负责对代码存储区（即FLASH 外设）的访问，分别是`I-Code`[^4] Buses和`D-Code`[^5] Buses。I-CODE and D-CODE busses cannot access the flash memory independently, they do however access the flash interface independently:
[^4]:I-code用于取址（fetch instructions ）
[^5]:D-code用于查表（D-CODE bus is used for data access in the code memory region (literal load).）

系统总线[^6]覆盖的趋于包括SRAM,片上外设,片外RAM,片外扩展设备,以及系统级存储区的部分空间。

[^6]:System busses 用于访问内存和外设

私有外设总线负责一部分私有外设的访问，主要就是访问调试组件。它们也在系统级
存储区。
还有一个MDA 总线，从字面上看，DMA 是data memory access 的意思，是一种连接
内核和外设的桥梁，它可以访问外设、内存，传输不受CPU 的控制，并且是双向通信。简
而言之，这个家伙就是一个速度很快的且不受老大控制的数据搬运工，这个在51 里面是没
有的。

**外设**

从结构框图上看，STM32 比51 的外设多得多，51 有的串口、定时器、IO 口等外设
STM32 都有。STM32 还多了很多特色外设：如FSMC、SDIO、SPI、I2C 等，这些外设按
照速度的不同，分别挂载到AHB、APB2、APB1 这三条总线上。

|学习方法||
| ---- |---|
|     51 |STM32|
|用寄存器编程|用库函数|

## 点亮LED

### 用51

在点亮LED 的时候，我们都是用操作寄存器的方法来实现的，那大家是否想过，这个
寄存器到底是什么？为什么我们可以直接操作P0 口？
解答上面的问题之前，我们先简单介绍下51 单片机的主要组成部分，这对我们学习其
他单片机也有好处。
我们以国内的STC89C51 为例，该单片机主要由51 内核、外设IP、和总线这三大部分
组成。内核是由Intel 公司生产的，外设IP 就是STC 公司在内核的基础上添加的诸如定时
器、串口、IO 口等这些东西，总线就是用来连接内核和外设的接口单元。Intel 在这里属于IP 核设计公司，STC 属于IC 设计公司。世界上能设计IP 核的公司屈指可数。ARM 公司就属于IP 核设计公司，ARM 给其他公司授权，其他IC 公司就在ARM 内
核上设计出各具特色的MCU，我们后面要学习的STM32 就是属于一中基于ARM 内核的
MCU。

寄存器则是内置于各个IP 外设中，是一种用于配置外设功能的存储器，就是一种内
存，并且有想对应的地址。学过C 语言我们就知道，要操作这些内存就可以使用C 语言中
的指针，通过寻址的方式来操作这些具有特殊功能的内存—寄存器。比如P0 口对应的地址
是0X80，那么我们要修改0X80 这个地址对应的内存的内容的话，按照常理可以这样操
作：
~~~c
*（*0X80）= 0XFE; // 点亮LED
~~~
可当我们编译的时候，编译器会报错，在51 里面只能通过SFR 和SBIT 这两个关键字
来实现寄存器映像，不能直接操作寄存器对应的地址，这是51 相较于STM32 不同的地
方。
51 单片机的这些寄存器位于地址80H~FFH 中，对应着128 个地址，但不是每个地址
都是有效的，51 系列的单片机有21 个，52 系列的则有26 个，其他的都是保留区。

实际上我们在编程的时候并不是通过指针来操作寄存器的，而是直接给P0、P1 这些
端口寄存器赋值。那么这些外设资源是如何与地址建立一一对应的关系（寄存器映射定
义），这得益与51 特有的两个关键字：SFR 和sbit，其他单片机没有，只能用其他的方式
来实现寄存器映射。这两个关键字帮我们实现了所有寄存器的定义，所以我们才可以像操
作普通变量一个来操作寄存器。其实我们一开始提到的点亮LED 的代码，全貌应该是这样
的：
~~~c
1 sfr P0 = 0x80; // 寄存器定义
2 P0 = 0XFE; // 总线操作点亮LED
~~~
为了方便起见，我们可以把寄存器映射全部写好封装在一个头文件里面，不用每用一
个寄存器就定义一次。其实这方面的工作不用我们做，我们在编程的时候都会在开始的地
方添加一个头文件：

还有一个就是启动代码，这个也是很多初学者容易忽略的地方，对于这部分我们主要
总结下它的功能，不详解讲解里面的代码。
单片机在上电复位后，首先执行的是启动文件—STARTUP.A51，而不是我们通常看到
的main 函数。我们新建51 工程的时候会有一个提示：是否拷贝启动代码到当前的工程，
我们一般选择是。
启动代码用汇编语言编写，主要实现了以下功能：清除内部数据存储器、清除外部数
据存储器、清除外部页储存器、初始化small 模式下的可重入栈和指针、初始化large 模式
下可重入栈和指针、初始化compact 模式下的可重入栈和指针、初始化8051 硬件栈指针、传递初始化全局变量的控制命令或者在没有初始化全局变量时给main 函数传递命令。然后程序就跳转到main 函数，来到我们熟知的C 世界。

### 用STM32

对比着51 点亮LED 的方法，我们先用操作寄存器的方法用STM32 点亮一个LED，然后再一步步完善代码，构建最简单的库函数，让我们知道库是怎么建立起来的。